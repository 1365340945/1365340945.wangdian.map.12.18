<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>网点地图</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <script src="https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <style>
        /* ========== 新增：密码验证样式 ========== */
        #auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999; /* 确保在所有元素最上层 */
        }
        #auth-input {
            padding: 12px 20px;
            font-size: 16px;
            width: 300px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #auth-btn {
            padding: 12px 40px;
            font-size: 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #auth-btn:hover {
            background: #0056b3;
        }
        #auth-error {
            color: red;
            margin-top: 10px;
            display: none;
        }
        /* ========== 原有样式（完全保留） ========== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { overflow: hidden; }
        .map-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #eee;
            transition: all 0.3s ease;
            width: 280px;
            overflow: hidden;
        }
        .map-controls.collapsed { width: 50px; }
        .control-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .control-header h3 { font-size: 14px; font-weight: bold; color: #333; margin: 0; }
        .collapse-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .control-content { padding: 12px; transition: all 0.3s ease; }
        .map-controls.collapsed .control-content { display: none; }
        .province-city-select {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        .province-city-select select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            color: #333;
        }
        .province-city-select button {
            padding: 8px 0;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 10px;
        }
        .btn-group button {
            padding: 8px 0;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        .edit-btn { background: #28a745; }
        .edit-btn.active { background: #dc3545; }
        .select-btn { background: #007bff; }
        .select-btn.active { background: #dc3545; }
        .calc-btn { background: #17a2b8; }
        .calc-btn:disabled { background: #ccc; cursor: not-allowed; }
        .clear-btn { background: #6c757d; }
        .sub-title {
            font-size: 12px;
            font-weight: bold;
            color: #333;
            margin: 10px 0 6px 0;
            padding-bottom: 4px;
            border-bottom: 1px solid #eee;
        }
        .distance-result {
            margin-top: 8px;
            padding: 8px;
            border: 1px solid #eee;
            border-radius: 4px;
            font-size: 12px;
            color: #333;
            min-height: 80px;
            max-height: 180px;
            overflow-y: auto;
            line-height: 1.4;
        }
        #map { width: 100vw; height: 100vh; background: #f5f5f5; }
        .marker-color-red { filter: hue-rotate(-15deg) saturate(4) !important; }
        .marker-color-blue { filter: hue-rotate(190deg) saturate(4) !important; }
        .marker-color-green { filter: hue-rotate(110deg) saturate(4) !important; }
        .marker-selected {
            filter: brightness(1.2) !important;
            transform: scale(1.2);
            transition: all 0.2s;
        }
        .location-label {
            pointer-events: none;
            white-space: normal;
            z-index: 999;
            text-align: center;
            width: max-content;
            transform: translateX(-50%);
        }
		.location-label span {
			font-family: "Microsoft YaHei", 微软雅黑, "Heiti SC", sans-serif;
			font-size: 12px;
			font-weight: 600;
			color: #000 !important;
			background: transparent;
			padding: 0 4px;
			-webkit-text-stroke: 0;
			text-stroke: 0;
			text-shadow: 1px 0 1px #fff,
						 -1px 0 1px #fff,
						 0 1px 2px #fff,
						 0 -1px 1px #fff;
			display: inline-block;
			width: 90px;
			word-break: break-all;
			white-space: normal;
			line-height: 1.2;
		}

		/* 新增：面板内缩小版筛选按钮样式 */
		.panel-filter-buttons {
		  margin-bottom: 10px; /* 和下方内容隔开 */
		  display: flex; /* 水平排列 */
		  gap: 5px; /* 按钮间距 */
		}
		.filter-btn-sm {
		  padding: 4px 8px; /* 缩小内边距（核心缩小点） */
		  border: none;
		  border-radius: 3px; /* 圆角更小巧 */
		  cursor: pointer;
		  font-size: 11px; /* 缩小字体 */
		  transition: all 0.2s;
		  color: white;
		  min-width: 30px; /* 保证按钮紧凑且不挤压 */
		}
		/* 不同颜色按钮基础样式 */
		.filter-green { background-color: #dc3545; }
		.filter-blue { background-color: #dc3545; }
		.filter-red { background-color: #dc3545; }
		/* 激活/禁用状态（点击切换） */
		.filter-btn-sm.active { opacity: 1; }
		.filter-btn-sm:not(.active) { opacity: 0.5; background-color: #6c757d; }
		.filter-btn-sm:hover { opacity: 1; /*  hover时恢复高亮 */ }

		
        .leaflet-control-zoom, .leaflet-attribution-control { display: none; }
    </style>
</head>
<body>
    <!-- ========== 新增：密码验证界面（放在最前面） ========== -->
    <div id="auth-container">
        <h2>请输入访问密码</h2>
        <input type="password" id="auth-input" placeholder="请输入密码">
        <button id="auth-btn">验证并进入</button>
        <div id="auth-error">密码错误，请重新输入！</div>
    </div>

    <!-- ========== 原有HTML结构（完全保留） ========== -->
    <div class="map-controls" id="mapControls">
        <div class="control-header" id="controlHeader">
            <h3>地图操作面板</h3>
            <button class="collapse-btn" id="collapseBtn">≡</button>
        </div>
        <div class="control-content">
			
			  <!-- 新增：面板内缩小版筛选按钮（放在最上方） -->
			  <div class="panel-filter-buttons">
				<button class="filter-btn-sm filter-green active" data-color="green">东兴</button>
				<button class="filter-btn-sm filter-blue active" data-color="blue">信达</button>
				<button class="filter-btn-sm filter-red active" data-color="red">中金</button>
			  </div>
			
            <div class="province-city-select">
                <select id="provinceSelect">
                    <option value="">请选择省份</option>
                </select>
                <select id="citySelect" disabled>
                    <option value="">请选择城市</option>
                </select>
                <button id="locationBtn">定位到所选区域</button>
            </div>
            <div class="sub-title">编辑模式</div>
            <div class="btn-group">
                <button id="editBtn" class="edit-btn">开启编辑模式</button>
            </div>
            <div class="sub-title">距离计算工具</div>
            <div class="btn-group">
                <button id="selectMarkerBtn" class="select-btn">选择点位（点击标记）</button>
                <button id="calcDistanceBtn" class="calc-btn" disabled>计算所有两两距离</button>
                <button id="clearSelectBtn" class="clear-btn">清空选中点位</button>
            </div>
            <div class="distance-result" id="distanceResult">
                1. 可选择省市定位到对应区域<br>
                2. 点击「选择点位」选中地图标记<br>
                3. 选择≥2个点位计算两两距离
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script>
        // ========== 新增：密码验证核心逻辑（简化优化，解决打不开问题） ==========
        // 【请修改这里】自定义你的密码（建议设为复杂字符串，比如：Map@2025!123）
        const AUTH_KEY = "zhongjincaifu"; 
        // 可选：是否开启本地缓存（验证一次后7天内无需重复输入）
        const ENABLE_CACHE = true; 
        const CACHE_EXPIRE = 7 * 24 * 60 * 60 * 1000; // 7天有效期

        // 元素获取（确保DOM加载完成后获取）
        let authContainer, authInput, authBtn, authError;
        let mapInitialized = false; // 防止重复初始化

        // 验证密码并进入地图
        function verifyPassword() {
            const inputPassword = authInput.value.trim();
            if (inputPassword === AUTH_KEY) {
                // 验证成功：隐藏验证界面
                authContainer.style.display = 'none';
                // 可选：写入本地缓存
                if (ENABLE_CACHE) {
                    localStorage.setItem('map_auth_cache', JSON.stringify({
                        key: AUTH_KEY,
                        expireTime: Date.now() + CACHE_EXPIRE
                    }));
                }
                // 初始化地图（确保只初始化一次）
                if (!mapInitialized) {
                    initMap();
                    mapInitialized = true;
                }
            } else {
                // 验证失败：提示错误，清空输入
                authError.style.display = 'block';
                authInput.value = '';
                // 3秒后隐藏错误提示
                setTimeout(() => {
                    authError.style.display = 'none';
                }, 3000);
            }
        }

        // 检查本地缓存（如果有有效缓存，直接进入地图）
        function checkCache() {
            if (!ENABLE_CACHE) return false;
            try {
                const cache = localStorage.getItem('map_auth_cache');
                if (!cache) return false;
                const { key, expireTime } = JSON.parse(cache);
                // 验证缓存是否有效
                return key === AUTH_KEY && Date.now() < expireTime;
            } catch (e) {
                localStorage.removeItem('map_auth_cache');
                return false;
            }
        }

        // ========== 原有代码（完全未修改，直接保留） ==========
        // 扩展L.Icon
        L.Icon.ColorMarker = L.Icon.extend({
            options: {
                iconUrl: 'https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
                shadowUrl: 'https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41],
                colorClass: ''
            },
            initialize: function(options) {
                L.Util.setOptions(this, options);
                this.options.className = this.options.colorClass;
                L.Icon.prototype.initialize.call(this, this.options);
            }
        });
        L.icon.colorMarker = function(options) { return new L.Icon.ColorMarker(options); };

        // GCJ2WGS转换函数
        var PI = 3.14159265358979324;
        function transformGCJ2WGS(gcjLat, gcjLon) {
            let d = delta(gcjLat, gcjLon)
            return {
              'lat': gcjLat - d.lat,
              'lon': gcjLon - d.lon
            }
        }
        function delta(lat, lon) {
            let a = 6378245.0 
            let ee = 0.00669342162296594323 
            let dLat = transformLat(lon - 105.0, lat - 35.0)
            let dLon = transformLon(lon - 105.0, lat - 35.0)
            let radLat = lat / 180.0 * PI
            let magic = Math.sin(radLat)
            magic = 1 - ee * magic * magic
            let sqrtMagic = Math.sqrt(magic)
            dLat = (dLat * 180.0) / ((a * (1 - ee)) / (magic * sqrtMagic) * PI)
            dLon = (dLon * 180.0) / (a / sqrtMagic * Math.cos(radLat) * PI)
            return {
              'lat': dLat,
              'lon': dLon
            }
        }
        function transformLat(x, y) {
            let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x))
            ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0
            ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0
            ret += (160.0 * Math.sin(y / 12.0 * PI) + 320 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0
            return ret
        }
        function transformLon(x, y) {
            let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x))
            ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0
            ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0
            ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0
            return ret
        }

        // 核心配置
        let map;
        let isEditMode = false;
        let isSelectingMarkers = false;
        let selectedPoints = [];
        let locationMarker = null; 
        let locationLabelMarker = null;
        const colorMarkerGroups = {
            'marker-color-green': { markers: [], labels: [] },
            'marker-color-blue': { markers: [], labels: [] },
            'marker-color-red': { markers: [], labels: [] }
        };

        // 固定点位数据（原始GCJ坐标，永不修改）
        const PLACES = [
{ name:'这里是未知', lng:117.277500, lat:31.879578, colorClass:'marker-color-green' },
{ name:'还是未知', lng:117.233911, lat:31.811451, colorClass:'marker-color-green' },
{ name:'定位', lng:116.490877, lat:39.894606, colorClass:'marker-color-green' },
{ name:'不知道哪里', lng:116.433274, lat:39.915215, colorClass:'marker-color-green' },
        ];
        const fixedMarkers = [];
		
		// 新增：标记显示/隐藏控制函数
		function toggleMarkerByColor(color, isShow) {
		  const colorKey = `marker-color-${color}`;
		  if (!colorMarkerGroups[colorKey]) return;
		  
		    // 新增：同步更新筛选状态
			updateFilterStatus(color, isShow);
		  
		  // 控制标记和标签的显示/隐藏（仅修改图层可见性，不修改坐标）
		  colorMarkerGroups[colorKey].markers.forEach(marker => {
			if (isShow) {
			  marker.addTo(map); // 显示：添加到地图
			} else {
			  marker.removeFrom(map); // 隐藏：从地图移除（坐标数据保留）
			}
		  });
		  colorMarkerGroups[colorKey].labels.forEach(label => {
			if (isShow) {
			  label.addTo(map);
			} else {
			  label.removeFrom(map);
			}
		  });
		}
		
		// 新增：存储筛选状态（默认全部启用）
		const filterStatus = {
		  green: true,
		  blue: true,
		  red: true
		};

		// 新增：更新筛选状态的函数（和按钮点击联动）
		function updateFilterStatus(color, isShow) {
		  filterStatus[color] = isShow;
		}


        // 省市数据
        const provinceCityData = {
            "北京市": ["北京市"], "天津市": ["天津市"], "上海市": ["上海市"], "重庆市": ["重庆市"],
            "河北省": ["石家庄市", "唐山市", "秦皇岛市", "邯郸市", "邢台市", "保定市", "张家口市", "承德市", "沧州市", "廊坊市", "衡水市"],
            "山西省": ["太原市", "大同市", "阳泉市", "长治市", "晋城市", "朔州市", "晋中市", "运城市", "忻州市", "临汾市", "吕梁市"],
            "辽宁省": ["沈阳市", "大连市", "鞍山市", "抚顺市", "本溪市", "丹东市", "锦州市", "营口市", "阜新市", "辽阳市", "盘锦市", "铁岭市", "朝阳市", "葫芦岛市"],
            "吉林省": ["长春市", "吉林市", "四平市", "辽源市", "通化市", "白山市", "松原市", "白城市", "延边朝鲜族自治州"],
            "黑龙江省": ["哈尔滨市", "齐齐哈尔市", "鸡西市", "鹤岗市", "双鸭山市", "大庆市", "伊春市", "佳木斯市", "七台河市", "牡丹江市", "黑河市", "绥化市", "大兴安岭地区"],
            "江苏省": ["南京市", "无锡市", "徐州市", "常州市", "苏州市", "南通市", "连云港市", "淮安市", "盐城市", "扬州市", "镇江市", "泰州市", "宿迁市"],
            "浙江省": ["杭州市", "宁波市", "温州市", "嘉兴市", "湖州市", "绍兴市", "金华市", "衢州市", "舟山市", "台州市", "丽水市"],
            "安徽省": ["合肥市", "芜湖市", "蚌埠市", "淮南市", "马鞍山市", "淮北市", "铜陵市", "安庆市", "黄山市", "滁州市", "阜阳市", "宿州市", "六安市", "亳州市", "池州市", "宣城市"],
            "福建省": ["福州市", "厦门市", "莆田市", "三明市", "泉州市", "漳州市", "南平市", "龙岩市", "宁德市"],
            "江西省": ["南昌市", "景德镇市", "萍乡市", "九江市", "新余市", "鹰潭市", "赣州市", "吉安市", "宜春市", "抚州市", "上饶市"],
            "山东省": ["济南市", "青岛市", "淄博市", "枣庄市", "东营市", "烟台市", "潍坊市", "济宁市", "泰安市", "威海市", "日照市", "临沂市", "德州市", "聊城市", "滨州市", "菏泽市"],
            "河南省": ["郑州市", "开封市", "洛阳市", "平顶山市", "安阳市", "鹤壁市", "新乡市", "焦作市", "濮阳市", "许昌市", "漯河市", "三门峡市", "南阳市", "商丘市", "信阳市", "周口市", "驻马店市"],
            "湖北省": ["武汉市", "黄石市", "十堰市", "宜昌市", "襄阳市", "鄂州市", "荆门市", "孝感市", "荆州市", "黄冈市", "咸宁市", "随州市", "恩施土家族苗族自治州"],
            "湖南省": ["长沙市", "株洲市", "湘潭市", "衡阳市", "邵阳市", "岳阳市", "常德市", "张家界市", "益阳市", "郴州市", "永州市", "怀化市", "娄底市", "湘西土家族苗族自治州"],
            "广东省": ["广州市", "韶关市", "深圳市", "珠海市", "汕头市", "佛山市", "江门市", "湛江市", "茂名市", "肇庆市", "惠州市", "梅州市", "汕尾市", "河源市", "阳江市", "清远市", "东莞市", "中山市", "潮州市", "揭阳市", "云浮市"],
            "广西壮族自治区": ["南宁市", "柳州市", "桂林市", "梧州市", "北海市", "防城港市", "钦州市", "贵港市", "玉林市", "百色市", "贺州市", "河池市", "来宾市", "崇左市"],
            "海南省": ["海口市", "三亚市", "三沙市", "儋州市"],
            "四川省": ["成都市", "自贡市", "攀枝花市", "泸州市", "德阳市", "绵阳市", "广元市", "遂宁市", "内江市", "乐山市", "南充市", "眉山市", "宜宾市", "广安市", "达州市", "雅安市", "巴中市", "资阳市", "阿坝藏族羌族自治州", "甘孜藏族自治州", "凉山彝族自治州"],
            "贵州省": ["贵阳市", "六盘水市", "遵义市", "安顺市", "毕节市", "铜仁市", "黔西南布依族苗族自治州", "黔东南苗族侗族自治州", "黔南布依族苗族自治州"],
            "云南省": ["昆明市", "曲靖市", "玉溪市", "保山市", "昭通市", "丽江市", "普洱市", "临沧市", "楚雄彝族自治州", "红河哈尼族彝族自治州", "文山壮族苗族自治州", "西双版纳傣族自治州", "大理白族自治州", "德宏傣族景颇族自治州", "怒江傈僳族自治州", "迪庆藏族自治州"],
            "西藏自治区": ["拉萨市", "日喀则市", "昌都市", "林芝市", "山南市", "那曲市", "阿里地区"],
            "陕西省": ["西安市", "铜川市", "宝鸡市", "咸阳市", "渭南市", "延安市", "汉中市", "榆林市", "安康市", "商洛市"],
            "甘肃省": ["兰州市", "嘉峪关市", "金昌市", "白银市", "天水市", "武威市", "张掖市", "平凉市", "酒泉市", "庆阳市", "定西市", "陇南市", "临夏回族自治州", "甘南藏族自治州"],
            "青海省": ["西宁市", "海东市", "海北藏族自治州", "黄南藏族自治州", "海南藏族自治州", "果洛藏族自治州", "玉树藏族自治州", "海西蒙古族藏族自治州"],
            "宁夏回族自治区": ["银川市", "石嘴山市", "吴忠市", "固原市", "中卫市"],
            "新疆维吾尔自治区": ["乌鲁木齐市", "克拉玛依市", "吐鲁番市", "哈密市", "昌吉回族自治州", "博尔塔拉蒙古自治州", "巴音郭楞蒙古自治州", "阿克苏地区", "克孜勒苏柯尔克孜自治州", "喀什地区", "和田地区", "伊犁哈萨克自治州", "塔城地区", "阿勒泰地区"],
            "台湾省": ["台北市", "新北市", "桃园市", "台中市", "台南市", "高雄市"],
            "香港特别行政区": ["香港特别行政区"], "澳门特别行政区": ["澳门特别行政区"]
        };
		
		// 新增：省份-省会映射表（覆盖所有省份/自治区/直辖市）
		const provinceCapitalMap = {
		  "北京市": "北京市",
		  "天津市": "天津市",
		  "上海市": "上海市",
		  "重庆市": "重庆市",
		  "河北省": "石家庄市",
		  "山西省": "太原市",
		  "辽宁省": "沈阳市",
		  "吉林省": "长春市",
		  "黑龙江省": "哈尔滨市",
		  "江苏省": "南京市",
		  "浙江省": "杭州市",
		  "安徽省": "合肥市",
		  "福建省": "福州市",
		  "江西省": "南昌市",
		  "山东省": "济南市",
		  "河南省": "郑州市",
		  "湖北省": "武汉市",
		  "湖南省": "长沙市",
		  "广东省": "广州市",
		  "广西壮族自治区": "南宁市",
		  "海南省": "海口市",
		  "四川省": "成都市",
		  "贵州省": "贵阳市",
		  "云南省": "昆明市",
		  "西藏自治区": "拉萨市",
		  "陕西省": "西安市",
		  "甘肃省": "兰州市",
		  "青海省": "西宁市",
		  "宁夏回族自治区": "银川市",
		  "新疆维吾尔自治区": "乌鲁木齐市",
		  "台湾省": "台北市",
		  "香港特别行政区": "香港特别行政区",
		  "澳门特别行政区": "澳门特别行政区"
		};
		
        const areaCenterCoords = {
            "北京市": { latlng: [39.914885, 116.403874], zoom: 14 }, "天津市": { latlng: [39.084158, 117.200983], zoom: 10 },
            "上海市": { latlng: [31.230416, 121.473701], zoom: 10 }, "重庆市": { latlng: [29.533155, 106.504962], zoom: 10 },
            "石家庄市": { latlng: [38.045475, 114.502464], zoom: 12 }, "太原市": { latlng: [37.857014, 112.548873], zoom: 12 },
            "沈阳市": { latlng: [41.796767, 123.429096], zoom: 12 }, "长春市": { latlng: [43.886841, 125.324501], zoom: 12 },
            "哈尔滨市": { latlng: [45.803775, 126.642464], zoom: 12 }, "南京市": { latlng: [32.060254, 118.796875], zoom: 12 },
            "杭州市": { latlng: [30.287459, 120.153576], zoom: 12 }, "合肥市": { latlng: [31.86119, 117.283042], zoom: 12 },
            "福州市": { latlng: [26.075302, 119.306239], zoom: 12 }, "南昌市": { latlng: [28.676493, 115.892151], zoom: 12 },
            "济南市": { latlng: [36.675808, 117.000923], zoom: 12 }, "郑州市": { latlng: [34.757975, 113.665412], zoom: 12 },
            "武汉市": { latlng: [30.592848, 114.305469], zoom: 12 }, "长沙市": { latlng: [28.19409, 112.982279], zoom: 12 },
            "广州市": { latlng: [23.125178, 113.280637], zoom: 12 }, "南宁市": { latlng: [22.82402, 108.320004], zoom: 12 },
            "成都市": { latlng: [30.659462, 104.065735], zoom: 12 }, "贵阳市": { latlng: [26.578343, 106.713478], zoom: 12 },
            "昆明市": { latlng: [25.040609, 102.712251], zoom: 12 }, "西安市": { latlng: [34.263161, 108.948024], zoom: 12 },
            "兰州市": { latlng: [36.058039, 103.823557], zoom: 12 }, "西宁市": { latlng: [36.617633, 101.778919], zoom: 11 },
            "银川市": { latlng: [38.46637, 106.278179], zoom: 12 }, "乌鲁木齐市": { latlng: [43.792818, 87.617735], zoom: 11 }
        };

        // 工具函数
        function calculateTwoPointDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const radLat1 = Math.PI * lat1 / 180;
            const radLat2 = Math.PI * lat2 / 180;
            const radLon1 = Math.PI * lon1 / 180;
            const radLon2 = Math.PI * lon2 / 180;
            const deltaLat = radLat2 - radLat1;
            const deltaLon = radLon2 - radLon1;
            const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                      Math.cos(radLat1) * Math.cos(radLat2) *
                      Math.sin(deltaLon/2) * Math.sin(deltaLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // 【关键】仅用原始GCJ坐标计算距离
        function calculateAllPairDistance(points) {
            if (points.length < 2) return [];
            const results = [];
            for (let i = 0; i < points.length; i++) {
                for (let j = i + 1; j < points.length; j++) {
                    const p1 = points[i];
                    const p2 = points[j];
                    // 强制使用原始GCJ坐标计算，忽略拖动后的展示坐标
                    const distM = calculateTwoPointDistance(p1.gcjLat, p1.gcjLon, p2.gcjLat, p2.gcjLon);
                    results.push({
                        pair: `${p1.name} ↔ ${p2.name}`,
                        km: (distM / 1000).toFixed(3),
                        m: Math.round(distM)
                    });
                }
            }
            return results;
        }

        function updateDistanceResult(html) {
            document.getElementById('distanceResult').innerHTML = html;
        }

        // 【关键】选中时仅存储原始GCJ坐标（用于测距），不存储展示坐标
        function toggleMarkerSelect(marker, place) {
            if (!isSelectingMarkers) return;
            const idx = selectedPoints.findIndex(p => p.name === place.name);
            if (idx > -1) {
                marker.getElement().classList.remove('marker-selected');
                selectedPoints.splice(idx, 1);
            } else {
                marker.getElement().classList.add('marker-selected');
                // 仅存储原始GCJ坐标和名称，用于测距
                selectedPoints.push({ 
                    name: place.name, 
                    gcjLat: place.gcjLat, // 原始GCJ纬度（仅这个用于计算）
                    gcjLon: place.gcjLon  // 原始GCJ经度（仅这个用于计算）
                });
            }
            document.getElementById('calcDistanceBtn').disabled = selectedPoints.length < 2;
            updateDistanceResult(selectedPoints.length === 0 
                ? '未选中任何点位，请点击地图标记选择' 
                : `已选中 ${selectedPoints.length} 个点位：${selectedPoints.map(p => p.name).join('、')}`);
        }

        function clearSelectedMarkers() {
            fixedMarkers.forEach(marker => marker.getElement().classList.remove('marker-selected'));
            selectedPoints = [];
            document.getElementById('calcDistanceBtn').disabled = true;
            updateDistanceResult('已清空选中点位，可重新选择计算');
        }

        // 创建标记
        function createMarkerWithLabel(latlng, colorClass, place) {
            const markerIcon = L.icon.colorMarker({ colorClass: colorClass });
            const marker = L.marker(latlng, { 
                icon: markerIcon, 
                draggable: false, 
                place: place 
            });
            const labelIcon = L.divIcon({
                className: 'location-label',
                html: `<span>${place.name}</span>`,
                iconSize: [100, 20],
                iconAnchor: [50, 0]
            });
            const labelMarker = L.marker(latlng, {
                icon: labelIcon,
                interactive: false,
                zIndexOffset: 10,
                offset: L.point(0, 45)
            });
            marker.on('click', () => toggleMarkerSelect(marker, place));
            // 拖动仅修改展示位置，不触碰任何原始数据
            marker.on('drag', (e) => {
                if (isEditMode) {
                    labelMarker.setLatLng(e.latlng);
                }
            });
            if (colorMarkerGroups[colorClass]) {
                colorMarkerGroups[colorClass].markers.push(marker);
                colorMarkerGroups[colorClass].labels.push(labelMarker);
            }
            return { marker, labelMarker };
        }

        // 隐藏标记逻辑
        function isMarkerInView(marker) {
            const mapBounds = map.getBounds();
            const markerLatLng = marker.getLatLng();
            return mapBounds.pad(0.01).contains(markerLatLng);
        }


		// 原有函数（需要修改）
		function handleSingleColorMarkerInView(colorClass, zoomThreshold) {
		  const currentZoom = map.getZoom();
		  const colorGroup = colorMarkerGroups[colorClass];
		  if (colorGroup.markers.length === 0) return;

		  // 新增：获取当前颜色的筛选状态（比如green/blue/red）
		  const color = colorClass.replace('marker-color-', '');
		  const isFilterEnabled = filterStatus[color]; // 读取筛选按钮状态
		  
		  const inViewMarkers = [];
		  const inViewLabels = [];
		  colorGroup.markers.forEach((marker, idx) => {
			if (isMarkerInView(marker)) {
			  inViewMarkers.push(marker);
			  inViewLabels.push(colorGroup.labels[idx]);
			}
		  });

		  // 核心修改：先判断筛选状态——如果禁用，直接隐藏所有该颜色标记
		  if (!isFilterEnabled) {
			inViewMarkers.forEach(m => map.removeLayer(m));
			inViewLabels.forEach(l => map.removeLayer(l));
			return; // 禁用状态下，直接返回，不执行后续缩放逻辑
		  }

		  // 原有缩放逻辑（仅在筛选启用时执行）
		  if (currentZoom <= zoomThreshold) {
			inViewMarkers.forEach(m => map.removeLayer(m));
			inViewLabels.forEach(l => map.removeLayer(l));
			if (inViewMarkers.length > 0) {
			  const randomIdx = Math.floor(Math.random() * inViewMarkers.length);
			  map.addLayer(inViewMarkers[randomIdx]);
			  map.addLayer(inViewLabels[randomIdx]);
			}
		  } else {
			inViewMarkers.forEach(m => map.addLayer(m));
			inViewLabels.forEach(l => map.addLayer(l));
		  }
		}
		

        function toggleMarkersByView() {
            if (isEditMode) return;
            const zoomThreshold = 6; 
            handleSingleColorMarkerInView('marker-color-red', zoomThreshold);
            handleSingleColorMarkerInView('marker-color-green', zoomThreshold);
            handleSingleColorMarkerInView('marker-color-blue', zoomThreshold);
        }
		
		// 按钮点击事件（修改后）
		document.querySelectorAll('.filter-btn-sm').forEach(btn => {
		  btn.addEventListener('click', function() {
			this.classList.toggle('active');
			const color = this.dataset.color;
			const isShow = this.classList.contains('active');
			
			// 1. 更新筛选状态
			updateFilterStatus(color, isShow);
			// 2. 控制标记显示/隐藏
			toggleMarkerByColor(color, isShow);
			// 3. 强制触发一次缩放逻辑，确保状态同步
			toggleMarkersByView();
		  });
		});

        // 初始化省市选择框
        function initProvinceCitySelect() {
            const provinceSel = document.getElementById('provinceSelect');
            const citySel = document.getElementById('citySelect');
            Object.keys(provinceCityData).forEach(prov => {
                const opt = document.createElement('option');
                opt.value = prov;
                opt.textContent = prov;
                provinceSel.appendChild(opt);
            });
            provinceSel.value = "北京市";
            provinceSel.addEventListener('change', () => {
                citySel.innerHTML = '<option value="">请选择城市</option>';
                citySel.disabled = !provinceSel.value;
                if (provinceSel.value) {
                    provinceCityData[provinceSel.value].forEach(city => {
                        const opt = document.createElement('option');
                        opt.value = city;
                        opt.textContent = city;
                        citySel.appendChild(opt);
                    });
                    citySel.value = provinceCityData[provinceSel.value][0];
                }
            });
            provinceSel.dispatchEvent(new Event('change'));
			document.getElementById('locationBtn').addEventListener('click', () => {
			  const prov = provinceSel.value;
			  const city = citySel.value;
			  if (!prov) {
				alert("请选择省份！");
				return;
			  }

			  // 1. 判断所选城市是否有坐标，无则用省会坐标（逻辑保留）
			  let targetCoords = null;
			  if (areaCenterCoords[city]) {
				targetCoords = areaCenterCoords[city];
			  } else {
				const capital = provinceCapitalMap[prov];
				targetCoords = areaCenterCoords[capital];
				alert(`当前城市暂无定位数据，已自动定位到${prov}省会：${capital}`);
			  }

			  // 2. 仅移动地图视角到目标位置（核心：不创建任何新标记）
			  map.setView(targetCoords.latlng, targetCoords.zoom);

			  // 3. 更新提示文本（告知仅定位视角，无新标记）
			  const name = city ? `${prov}${city}` : prov;
			  updateDistanceResult(`已定位到：${name}（仅调整地图视角，未添加新坐标），可选择现有点位计算距离`);
			});
        }

        // 初始化地图
        function initMap() {
            map = L.map('map', { 
				preferCanvas: true, 
				zoomControl: false, 
				attributionControl: true,
				maxZoom: 18,
				minZoom: 3
			}).setView([39.914885, 116.403874], 14);
			L.tileLayer('http://t0.tianditu.gov.cn/DataServer?T=vec_w&x={x}&y={y}&l={z}&tk=bd2209e459772c4574ea71538ad06d99', {
				subdomains: ['0'],
				maxZoom: 18,
				minZoom: 3,
				crossOrigin: 'anonymous',
				attribution: '© 天地图'
			}).addTo(map);
			L.tileLayer('http://t0.tianditu.gov.cn/DataServer?T=cva_w&x={x}&y={y}&l={z}&tk=bd2209e459772c4574ea71538ad06d99', {
				subdomains: ['0'],
				maxZoom: 18,
				minZoom: 3,
				crossOrigin: 'anonymous'
			}).addTo(map);

            // 加载点位：GCJ转WGS作为初始展示坐标
            PLACES.forEach(place => {
                const wgs = transformGCJ2WGS(place.lat, place.lng);
                const placeWithWGS = {
                    ...place,
                    gcjLat: place.lat, // 原始GCJ坐标（永久保留，用于计算）
                    gcjLon: place.lng,
                    lat: wgs.lat,      // 转换后的展示坐标（可拖动修改）
                    lng: wgs.lon
                };
                const { marker, labelMarker } = createMarkerWithLabel(
                    [placeWithWGS.lat, placeWithWGS.lng],
                    placeWithWGS.colorClass,
                    placeWithWGS
                );
                marker.addTo(map);
                labelMarker.addTo(map);
                fixedMarkers.push(marker);
            });

            initProvinceCitySelect();
            map.on('zoomend moveend', toggleMarkersByView);
            toggleMarkersByView();

            // 折叠面板
            const controls = document.getElementById('mapControls');
            const collapseBtn = document.getElementById('collapseBtn');
            document.getElementById('controlHeader').addEventListener('click', () => {
                controls.classList.toggle('collapsed');
                collapseBtn.innerText = controls.classList.contains('collapsed') ? '≡' : '≡';
            });

            // 【核心修改】编辑模式：关闭时不恢复坐标，仅禁用拖动
            const editBtn = document.getElementById('editBtn');
            editBtn.addEventListener('click', () => {
                isEditMode = !isEditMode;
                editBtn.classList.toggle('active');
                editBtn.innerText = isEditMode ? '关闭编辑模式' : '开启编辑模式';
                
                fixedMarkers.forEach(marker => {
                    if (isEditMode) {
                        marker.dragging.enable(); // 开启编辑：允许拖动
                    } else {
                        marker.dragging.disable(); // 关闭编辑：仅禁用拖动，不恢复坐标
                        // 【删除了恢复坐标的所有逻辑】
                    }
                });
                
                updateDistanceResult(isEditMode 
                    ? '编辑模式已开启，可拖动标记调整展示位置（修改后不恢复）' 
                    : '编辑模式已关闭，标记保留拖动后的位置（测距仍用原始坐标）');
            });

            // 选点模式
            const selectBtn = document.getElementById('selectMarkerBtn');
            selectBtn.addEventListener('click', () => {
                isSelectingMarkers = !isSelectingMarkers;
                selectBtn.classList.toggle('active');
                if (isSelectingMarkers) {
                    selectBtn.innerText = '退出选点模式（点击标记取消/选中）';
                    updateDistanceResult('选点模式已开启，点击标记选择（测距仅用原始GCJ坐标）');
                } else {
                    selectBtn.innerText = '选择点位（点击标记）';
                    clearSelectedMarkers();
                    updateDistanceResult('选点模式已关闭，已自动清空选中点位');
                }
            });

            // 计算距离
            document.getElementById('calcDistanceBtn').addEventListener('click', () => {
                const distances = calculateAllPairDistance(selectedPoints);
                let html = `<strong>选中 ${selectedPoints.length} 个点位，两两距离（原始GCJ坐标）：</strong><br><br>`;
                distances.forEach((d, i) => {
                    html += `${i+1}. ${d.pair}：${d.km} 公里（${d.m} 米）<br><br>`;
                });
                updateDistanceResult(html);
            });

            // 清空选中
            document.getElementById('clearSelectBtn').addEventListener('click', clearSelectedMarkers);
        }

        // ========== 新增：页面加载后初始化密码验证逻辑 ==========
        window.addEventListener('DOMContentLoaded', () => {
            // 确保DOM完全加载后再获取验证相关元素
            authContainer = document.getElementById('auth-container');
            authInput = document.getElementById('auth-input');
            authBtn = document.getElementById('auth-btn');
            authError = document.getElementById('auth-error');

            // 先检查缓存，有则直接进入
            if (checkCache()) {
                authContainer.style.display = 'none';
                if (!mapInitialized) {
                    initMap();
                    mapInitialized = true;
                }
            } else {
                // 绑定验证按钮点击事件
                authBtn.addEventListener('click', verifyPassword);
                // 绑定回车触发验证
                authInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') verifyPassword();
                });
            }
        });
    </script>
</body>
</html>